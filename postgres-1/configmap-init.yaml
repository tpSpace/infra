apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-llm-init
  namespace: my-thesis
data:
  01-init-db.sql: |
    -- Create database if it doesn't exist
    SELECT 'CREATE DATABASE grading_service'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'grading_service')\gexec

    -- Connect to the grading_service database
    \c grading_service;

    -- Create user if it doesn't exist
    DO $$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'grading_user') THEN
        CREATE USER grading_user WITH PASSWORD 'GradingService123!';
      END IF;
    END
    $$;

    -- Grant privileges
    GRANT ALL PRIVILEGES ON DATABASE grading_service TO grading_user;
    GRANT ALL ON SCHEMA public TO grading_user;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO grading_user;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO grading_user;

    -- Set default privileges for future objects
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO grading_user;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO grading_user;

    -- Enable necessary extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";
